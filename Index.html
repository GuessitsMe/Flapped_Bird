<!DOCTYPE html>
<html>
<head> 
<style>
  * { box-sizing: border-box; }
  body { margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; background: #1a1a1a; }
  
  /* Skin color variables */
  :root {
    --bird-color: #fdf000;
    --pipe-gradient: linear-gradient(to right, #73bf2e, #a0d86b, #559021);
  }
  
  #auth-container { position: fixed; top: 0; left: 0; right: 0; height: 40px; background: #2a2a2a; border-bottom: 2px solid #e86101; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; z-index: 1000; color: white; }
  #user-info { display: flex; gap: 20px; align-items: center; font-size: 12px; }
  #currency { background: #e86101; padding: 4px 10px; border-radius: 4px; font-weight: bold; }
  #logout-btn { background: #e86101; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
  #login-btn { background: #2ecc71; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
  
  #game-wrapper { display: flex; justify-content: center; align-items: center; height: calc(100vh - 40px); margin-top: 40px; background: #1a1a1a; }
  #game { position: relative; width: 320px; height: 480px; border: 4px solid #fff; overflow: hidden; transition: background 3s ease; background: #70c5ce; box-shadow: 0 0 50px rgba(0,0,0,0.5); touch-action: manipulation; user-select: none; }
  
  .building { position: absolute; bottom: 40px; background: #4ca4ab; z-index: 1; display: grid; padding: 4px; gap: 3px; border: 1px solid rgba(0,0,0,0.2); transition: background 3s; }
  .window { background: rgba(255,255,255,0.2); width: 100%; height: 100%; border-radius: 1px; }
  .window.lit { background: #fdf000; box-shadow: 0 0 4px #fdf000; }
  .cloud { position: absolute; background: white; border-radius: 20px; opacity: 0.6; z-index: 2; }
  #ground { position: absolute; bottom: 0; width: 640px; height: 40px; background: #ded895; border-top: 4px solid #543847; z-index: 5; }

  #bird { position: absolute; left: 50px; top: 230px; width: 22px; height: 20px; background: var(--bird-color); border: 2px solid #000; border-radius: 50%; z-index: 10; box-shadow: inset -4px -4px 0 rgba(0,0,0,0.2); transform-origin: center; }
  #bird::before { content: ''; position: absolute; top: 4px; right: 4px; width: 4px; height: 4px; background: black; border-radius: 50%; } 
  #bird::after { content: ''; position: absolute; top: 8px; right: -6px; width: 8px; height: 6px; background: #f00; border-radius: 2px; border: 1px solid #000; } 
  #wing { position: absolute; left: -4px; top: 4px; width: 12px; height: 10px; background: white; border: 1px solid #000; border-radius: 50% 20%; transform-origin: right center; }
  .flap { transform: rotate(-65deg); } 

  .pipe { position: absolute; width: 50px; background: var(--pipe-gradient); border: 2px solid #000; z-index: 4; }
  .pipe-cap { position: absolute; width: 60px; height: 22px; background: var(--pipe-gradient); border: 2px solid #000; left: -7px; z-index: 5; border-radius: 3px; }

  #score { position: absolute; top: 10px; width: 100%; text-align: center; font-size: 40px; color: white; text-shadow: 3px 3px #000; z-index: 20; display: none; }
  #coins-display { position: absolute; top: 55px; right: 12px; background: #2ecc71; padding: 4px 10px; border-radius: 4px; color: white; font-weight: bold; font-size: 14px; z-index: 25; display: none; }
  #champion-box { background: linear-gradient(135deg, #fdf000, #e86101); border: 4px solid #543847; padding: 10px; color: #543847; border-radius: 8px; width: 95%; max-width: 220px; margin: 0 auto 12px; text-align: center; }
  #champion-name { font-size: 18px; font-weight: bold; margin: 5px 0; }
  #champion-score { font-size: 14px; margin: 5px 0; }
  #shop-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 50%, #0a0e27 0%, #0d1b3a 25%, #000 50%), radial-gradient(circle at 80% 80%, #1a0a2e 0%, #0d0015 100%); z-index: 1500; overflow-y: auto; padding: 10px; }
  #shop-modal::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)), radial-gradient(2px 2px at 60px 70px, #fff, rgba(0,0,0,0)), radial-gradient(1px 1px at 50px 50px, #fff, rgba(0,0,0,0)), radial-gradient(1px 1px at 100px 10px, #fff, rgba(0,0,0,0)), radial-gradient(2px 2px at 130px 80px, #fff, rgba(0,0,0,0)), radial-gradient(1px 1px at 180px 120px, #eee, rgba(0,0,0,0)); background-size: 200px 200px; background-repeat: repeat; z-index: 0; pointer-events: none; opacity: 0.8; }
  #shop-content { max-width: 320px; margin: 0 auto; background: rgba(42, 42, 42, 0.95); padding: 15px; border-radius: 8px; border: 3px solid #00d4ff; color: white; position: relative; z-index: 1; box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
  #shop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; }
  #shop-header h2 { margin: 0; font-size: 18px; }
  #close-shop { background: #e86101; border: none; color: white; padding: 4px 8px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 12px; flex-shrink: 0; }
  #shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .shop-item { background: #1a1a1a; border: 2px solid #543847; padding: 8px; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s; }
  .shop-item:hover { border-color: #e86101; transform: scale(1.03); }
  .shop-item-icon { font-size: 28px; margin-bottom: 3px; }
  .shop-item-name { font-weight: bold; font-size: 11px; margin-bottom: 2px; line-height: 1.2; }
  .shop-item-price { background: #2ecc71; color: black; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 10px; margin-bottom: 4px; display: inline-block; }
  .shop-item-desc { font-size: 9px; color: #aaa; margin-bottom: 6px; line-height: 1.2; }
  .shop-buy-btn, .shop-equip-btn { background: #2ecc71; border: none; color: black; padding: 4px 8px; cursor: pointer; border-radius: 3px; font-weight: bold; font-size: 10px; width: 100%; }
  .shop-buy-btn:hover, .shop-equip-btn:hover { background: #27ae60; }
  .shop-buy-btn:disabled, .shop-equip-btn:disabled { background: #555; cursor: not-allowed; color: #999; }
  .shop-equip-btn { background: #3498db; }
  .shop-equip-btn:hover { background: #2980b9; }
  #locker-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1500; overflow-y: auto; padding: 10px; }
  #locker-content { max-width: 320px; margin: 0 auto; background: #2a2a2a; padding: 15px; border-radius: 8px; border: 3px solid #9b59b6; color: white; }
  #locker-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; }
  #locker-header h2 { margin: 0; font-size: 18px; }
  #close-locker { background: #9b59b6; border: none; color: white; padding: 4px 8px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 12px; flex-shrink: 0; }
  .locker-category { margin-bottom: 12px; }
  .locker-category-title { font-weight: bold; font-size: 12px; color: #9b59b6; margin-bottom: 6px; text-transform: uppercase; }
  .locker-items { display: flex; flex-direction: column; gap: 6px; }
  .locker-item { background: #1a1a1a; border: 2px solid #543847; padding: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
  .locker-item.equipped { border-color: #9b59b6; background: rgba(155, 89, 182, 0.1); }
  .locker-item-info { font-size: 11px; }
  .locker-item-name { font-weight: bold; }
  .locker-item-status { font-size: 9px; color: #9b59b6; }
  .locker-equip-btn { background: #9b59b6; border: none; color: white; padding: 4px 8px; cursor: pointer; border-radius: 3px; font-weight: bold; font-size: 10px; }
  .locker-equip-btn:hover { background: #8e44ad; }
  #pauseBtn { position: absolute; top: 12px; right: 12px; width: 36px; height: 36px; background: #e86101; border: 3px solid white; border-radius: 50%; cursor: pointer; z-index: 50; display: none; box-shadow: 0 3px 0 #a04300; }
  #pauseBtn::before, #pauseBtn::after { content: ''; position: absolute; top: 50%; width: 4px; height: 14px; background: white; transform: translateY(-50%); border-radius: 2px; }
  #pauseBtn::before { left: 11px; } #pauseBtn::after { right: 11px; }

  #menu, #ready-overlay, #pause-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 30; color: white; text-align: center; }
  #menu { background: rgba(0,0,0,0.6); }
  #pause-overlay, #ready-overlay { display: none; }
  .stat-box { background: #ded895; border: 3px solid #543847; padding: 12px; color: #543847; border-radius: 8px; width: 95%; max-width: 240px; margin: 0 auto 15px; }
  
  #save-section { margin-bottom: 15px; display: none; }
  #player-name { padding: 8px; border-radius: 4px; border: none; width: 140px; text-align: center; font-family: inherit; }
  .btn-save { background: #2ecc71; margin-top: 5px; padding: 5px 10px; font-size: 14px; color: white; border: none; border-radius: 4px; cursor: pointer; }
  .btn-login-prompt { background: #2ecc71; padding: 5px 15px; font-size: 12px; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; }

  button { padding: 8px 16px; font-size: 16px; cursor: pointer; background: #e86101; border: 3px solid white; color: white; border-radius: 5px; font-weight: bold; white-space: nowrap; }
  #flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 100; pointer-events: none; }
  .flash-active { animation: flashEffect 0.2s; }
  @keyframes flashEffect { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
</style>
</head>
<body>

<div id="auth-container">
  <div style="font-weight: bold;">FLAPPY BIRD</div>
  <div id="user-info" style="display: none;">
    <span id="user-name" onclick="editName()" style="cursor: pointer; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); hover: background rgba(255,255,255,0.2);"></span>
    <span id="currency">üí∞ 0</span>
    <button id="logout-btn" onclick="logout()">LOGOUT</button>
  </div>
  <button id="login-btn" onclick="login()" style="display: none;">LOGIN WITH GOOGLE</button>
</div>

<div id="name-edit-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center;">
  <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border: 2px solid #e86101; color: white; text-align: center;">
    <h3>CHANGE YOUR NAME</h3>
    <input type="text" id="name-input" maxlength="20" placeholder="Max 20 characters" style="padding: 8px; border-radius: 4px; border: none; width: 180px; text-align: center; margin: 10px 0;">
    <div>
      <button onclick="saveName()" style="background: #2ecc71; padding: 8px 15px; margin-right: 5px;">SAVE</button>
      <button onclick="closeName()" style="background: #e86101; padding: 8px 15px;">CANCEL</button>
    </div>
  </div>
</div>

<div id="game-wrapper">
<div id="game">
  <div id="flash"></div>
  <div id="score">0</div>
  <div id="coins-display">üí∞ 0</div>
  <button id="pauseBtn" onclick="togglePause()"></button>
  <div id="pause-overlay"><h1>PAUSED</h1><p>Press 'P' to Resume</p></div>
  <div id="ready-overlay"><h2 style="text-shadow: 2px 2px #e86101;">GET READY</h2><p>SPACE OR CLICK TO JUMP</p></div>
  <div id="bird"><div id="wing"></div></div>
  <div id="ground"></div>
  <div id="menu">
      <h2 style="text-shadow: 2px 2px #e86101;">FLAPPY BIRD</h2>
      <div id="champion-box" style="display: none;">
          <p style="font-size: 10px; margin: 0; color: #543847;">üëë #1 CHAMPION üëë</p>
          <div id="champion-name">---</div>
          <div id="champion-score" style="font-size: 13px;">Score: 0</div>
      </div>
      <div class="stat-box">
          <p style="font-size:11px; margin:0">SCORE</p><h2 id="final-score" style="margin:3px 0; font-size:20px;">0</h2>
          <hr style="border:1px solid #543847; opacity: 0.3; margin: 5px 0;">
          <p style="font-size:11px; margin:0">BEST</p><h2 id="high-score" style="margin:3px 0; font-size:20px;">0</h2>
          <ul id="leaderboard-list" style="list-style:none; padding:0; margin-top:8px; font-size:10px; text-align:left; border-top:1px solid rgba(0,0,0,0.1); padding-top:5px; max-height:120px; overflow-y:auto;"></ul>
      </div>
      <div id="save-section" style="display: none;">
          <p id="save-message" style="font-size: 14px; margin-bottom: 10px; color: #2ecc71; font-weight: bold; text-shadow: 1px 1px 2px #000;"></p>
          <input type="text" id="player-name" placeholder="ENTER YOUR NAME" maxlength="20" style="display: none;">
          <button class="btn-save" id="save-name-btn" style="display: none;" onclick="saveNameToBoard()">SAVE NAME</button>
      </div>
      <div style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; width: 100%;">
        <button id="start-btn" onclick="showReady()" style="flex: 1 1 auto; min-width: 70px;">START</button>
        <button id="shop-btn" onclick="openShop()" style="display: none; background: #2ecc71; flex: 1 1 auto; min-width: 65px; font-size: 13px; padding: 8px 10px;">üõçÔ∏è SHOP</button>
        <button id="locker-btn" onclick="openLocker()" style="display: none; background: #9b59b6; flex: 1 1 auto; min-width: 65px; font-size: 13px; padding: 8px 10px;">üîì LOCKER</button>
      </div>
  </div>
</div>
</div>

<div id="shop-modal">
  <div id="shop-content">
    <div id="shop-header">
      <h2>üõçÔ∏è SHOP</h2>
      <button id="close-shop" onclick="closeShop()">CLOSE</button>
    </div>
    <div style="margin-bottom: 15px; text-align: center;">
      <p style="margin: 5px 0; font-size: 14px;">üí∞ Your Balance: <span id="shop-currency" style="font-weight: bold; color: #2ecc71;">0</span></p>
    </div>
    <div id="shop-grid"></div>
  </div>
</div>

<div id="locker-modal">
  <div id="locker-content">
    <div id="locker-header">
      <h2>üîì LOCKER</h2>
      <button id="close-locker" onclick="closeLocker()">CLOSE</button>
    </div>
    <div id="locker-items-container"></div>
  </div>
</div>

<script>
  let currentUser = null;
  let isLoggedIn = false;
  
  async function loadEquippedSkins() {
    try {
      const res = await fetch('/api/inventory');
      if (res.ok) {
        const inventory = await res.json();
        equippedBirdSkin = null;
        equippedPipeSkin = null;
        equippedBackground = 'day';
        for (const item of inventory) {
          if (item.is_equipped) {
            if (item.item_type === 'bird_skin') equippedBirdSkin = item.item_id;
            if (item.item_type === 'pipe_skin') equippedPipeSkin = item.item_id;
            if (item.item_type === 'background_theme') equippedBackground = item.item_id;
          }
        }
        applySkins();
      }
    } catch (e) {
      console.error('Failed to load skins:', e);
    }
  }
  
  function applySkins() {
    const birdColor = equippedBirdSkin ? (skinColorMap[equippedBirdSkin] || '#fdf000') : '#fdf000';
    const pipeGradient = equippedPipeSkin ? (pipeGradientMap[equippedPipeSkin] || 'linear-gradient(to right, #73bf2e, #a0d86b, #559021)') : 'linear-gradient(to right, #73bf2e, #a0d86b, #559021)';
    const bgColor = backgroundThemeMap[equippedBackground] || '#70c5ce';
    document.documentElement.style.setProperty('--bird-color', birdColor);
    document.documentElement.style.setProperty('--pipe-gradient', pipeGradient);
    game.style.background = bgColor;
  }

  async function checkAuth() {
    try {
      const res = await fetch('/api/user');
      if (res.ok) {
        currentUser = await res.json();
        isLoggedIn = true;
        updateAuthUI();
        if (isLoggedIn) loadEquippedSkins();
      } else {
        isLoggedIn = false;
        updateAuthUI();
      }
    } catch (e) {
      isLoggedIn = false;
      updateAuthUI();
    }
  }

  function updateAuthUI() {
    const userInfo = document.getElementById('user-info');
    const loginBtn = document.getElementById('login-btn');
    const userName = document.getElementById('user-name');
    const currency = document.getElementById('currency');
    const shopBtn = document.getElementById('shop-btn');
    const lockerBtn = document.getElementById('locker-btn');
    
    if (isLoggedIn && currentUser) {
      userInfo.style.display = 'flex';
      loginBtn.style.display = 'none';
      shopBtn.style.display = 'block';
      lockerBtn.style.display = 'block';
      userName.innerText = currentUser.display_name || currentUser.first_name || 'Player';
      currency.innerText = 'üí∞ ' + currentUser.currency;
    } else {
      userInfo.style.display = 'none';
      loginBtn.style.display = 'block';
      shopBtn.style.display = 'none';
      lockerBtn.style.display = 'none';
    }
  }

  async function openShop() {
    document.getElementById('shop-modal').style.display = 'block';
    document.getElementById('shop-currency').innerText = currentUser.currency;
    
    try {
      const res = await fetch('/api/shop');
      const items = await res.json();
      const grid = document.getElementById('shop-grid');
      grid.innerHTML = '';
      
      for (const item of items) {
        const owned = await checkIfOwned(item.item_type, item.item_id);
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.innerHTML = `
          <div class="shop-item-icon">${item.icon || 'üì¶'}</div>
          <div class="shop-item-name">${item.name}</div>
          <div class="shop-item-desc">${item.description || ''}</div>
          <div class="shop-item-price">üí∞ ${item.price}</div>
          <button class="shop-buy-btn" ${owned ? 'disabled' : ''} onclick="buyItem(${item.id}, '${item.name}', ${item.price})">
            ${owned ? 'OWNED' : 'BUY'}
          </button>
        `;
        grid.appendChild(div);
      }
    } catch (e) {
      console.error('Shop error:', e);
      document.getElementById('shop-grid').innerHTML = '<p>Failed to load shop</p>';
    }
  }

  function closeShop() {
    document.getElementById('shop-modal').style.display = 'none';
  }

  async function checkIfOwned(itemType, itemId) {
    try {
      const res = await fetch('/api/inventory');
      const items = await res.json();
      return items.some(i => i.item_type === itemType && i.item_id === itemId);
    } catch (e) {
      return false;
    }
  }

  async function buyItem(itemId, itemName, price) {
    if (currentUser.currency < price) {
      alert('Not enough coins!');
      return;
    }

    try {
      const res = await fetch('/api/shop/buy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId })
      });

      if (res.ok) {
        const data = await res.json();
        alert('‚úÖ ' + data.message);
        currentUser.currency = data.new_balance;
        updateAuthUI();
        openShop();
      } else {
        const data = await res.json();
        alert('‚ùå ' + (data.error || 'Purchase failed'));
      }
    } catch (e) {
      console.error('Buy error:', e);
      alert('Error purchasing item');
    }
  }

  async function openLocker() {
    document.getElementById('locker-modal').style.display = 'block';
    
    try {
      const [invRes, shopRes] = await Promise.all([
        fetch('/api/inventory'),
        fetch('/api/shop')
      ]);
      
      const inventory = await invRes.json();
      const shopItems = await shopRes.json();
      
      const itemMap = {};
      for (const item of shopItems) {
        itemMap[item.item_id] = item;
      }
      
      const grouped = {};
      for (const inv of inventory) {
        if (!grouped[inv.item_type]) grouped[inv.item_type] = [];
        grouped[inv.item_type].push(inv);
      }
      
      const container = document.getElementById('locker-items-container');
      container.innerHTML = '';
      
      const categories = {
        'bird_skin': 'üê¶ Bird Skins',
        'pipe_skin': 'üîß Pipe Skins',
        'background_theme': 'üé® Game Themes'
      };
      
      for (const [type, label] of Object.entries(categories)) {
        if (grouped[type] && grouped[type].length > 0) {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'locker-category';
          
          const titleDiv = document.createElement('div');
          titleDiv.className = 'locker-category-title';
          titleDiv.innerText = label;
          categoryDiv.appendChild(titleDiv);
          
          const itemsDiv = document.createElement('div');
          itemsDiv.className = 'locker-items';
          
          for (const invItem of grouped[type]) {
            const shopItem = itemMap[invItem.item_id];
            if (!shopItem) continue;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'locker-item' + (invItem.is_equipped ? ' equipped' : '');
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'locker-item-info';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'locker-item-name';
            nameDiv.innerText = (shopItem.icon || '') + ' ' + shopItem.name;
            infoDiv.appendChild(nameDiv);
            
            if (invItem.is_equipped) {
              const statusDiv = document.createElement('div');
              statusDiv.className = 'locker-item-status';
              statusDiv.innerText = '‚úì EQUIPPED';
              infoDiv.appendChild(statusDiv);
            }
            
            itemDiv.appendChild(infoDiv);
            
            const btn = document.createElement('button');
            btn.className = 'locker-equip-btn';
            btn.innerText = invItem.is_equipped ? 'UNEQUIP' : 'EQUIP';
            btn.onclick = () => equipItem(type, invItem.item_id, !invItem.is_equipped);
            
            itemDiv.appendChild(btn);
            itemsDiv.appendChild(itemDiv);
          }
          
          categoryDiv.appendChild(itemsDiv);
          container.appendChild(categoryDiv);
        }
      }
      
      if (Object.values(grouped).every(v => !v || v.length === 0)) {
        container.innerHTML = '<p style="text-align: center; color: #aaa; font-size: 12px;">No items yet. Buy some in the shop!</p>';
      }
    } catch (e) {
      console.error('Locker error:', e);
      document.getElementById('locker-items-container').innerHTML = '<p>Failed to load locker</p>';
    }
  }

  function closeLocker() {
    document.getElementById('locker-modal').style.display = 'none';
  }

  async function equipItem(itemType, itemId, equip) {
    try {
      const res = await fetch('/api/inventory/equip', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_type: itemType, item_id: itemId })
      });

      if (res.ok) {
        const data = await res.json();
        if (data.equipped === false) {
          if (itemType === 'bird_skin') equippedBirdSkin = null;
          if (itemType === 'pipe_skin') equippedPipeSkin = null;
          if (itemType === 'background_theme') equippedBackground = 'day';
        } else {
          if (itemType === 'bird_skin') equippedBirdSkin = itemId;
          if (itemType === 'pipe_skin') equippedPipeSkin = itemId;
          if (itemType === 'background_theme') equippedBackground = itemId;
        }
        applySkins();
        openLocker();
      } else {
        const data = await res.json();
        alert('‚ùå ' + (data.error || 'Failed to equip'));
      }
    } catch (e) {
      console.error('Equip error:', e);
      alert('Error equipping item');
    }
  }

  function editName() {
    if (!isLoggedIn) return;
    document.getElementById('name-edit-modal').style.display = 'flex';
    document.getElementById('name-input').value = currentUser.display_name || currentUser.first_name || '';
    document.getElementById('name-input').focus();
  }

  function closeName() {
    document.getElementById('name-edit-modal').style.display = 'none';
  }

  async function saveName() {
    const newName = document.getElementById('name-input').value.trim();
    if (!newName) {
      alert('Please enter a name');
      return;
    }

    try {
      const res = await fetch('/api/user/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ display_name: newName })
      });

      if (res.ok) {
        currentUser.display_name = newName;
        updateAuthUI();
        closeName();
      } else {
        const data = await res.json();
        alert(data.error || 'Failed to update name');
      }
    } catch (err) {
      console.error('Error:', err);
      alert('Error updating name');
    }
  }

  function login() {
    window.location.href = '/auth/replit_auth';
  }

  function logout() {
    window.location.href = '/auth/logout';
  }

  const bird = document.getElementById('bird'), wing = document.getElementById('wing'), game = document.getElementById('game'), flash = document.getElementById('flash'), scoreEl = document.getElementById('score'), menu = document.getElementById('menu'), readyOverlay = document.getElementById('ready-overlay'), pauseOverlay = document.getElementById('pause-overlay'), pauseBtn = document.getElementById('pauseBtn'), finalScoreEl = document.getElementById('final-score'), highScoreEl = document.getElementById('high-score'), groundEl = document.getElementById('ground');
  
  let by = 230, bv = 0, pipes = [], clouds = [], buildings = [], score = 0, coinsEarned = 0, running = false, waiting = false, isPaused = false, isDead = false, highscore = localStorage.getItem('highscore') || 0, groundX = 0, rotation = 0, tick = 0, equippedBirdSkin = null, equippedPipeSkin = null, equippedBackground = 'day';
  
  const backgroundThemeMap = {
    'day': '#70c5ce',
    'night': '#1a1a2e',
    'sunset': '#ff6b5b',
    'ocean': '#1e3a8a',
    'space': '#0f0f1e'
  };
  
  const skinColorMap = {
    'red': '#fdf000',
    'blue': '#4dd0e1',
    'gold': '#ffd700'
  };
  
  const pipeGradientMap = {
    'purple': 'linear-gradient(to right, #9b59b6, #c39bd3, #7d3c98)',
    'rainbow': 'linear-gradient(to right, #e74c3c, #f39c12, #2ecc71, #3498db, #9b59b6)',
    'default': 'linear-gradient(to right, #73bf2e, #a0d86b, #559021)'
  };
  const gravity = 0.28, jump = -6.5, gameSpeed = 4.5;

  async function fetchLeaderboard() {
    try {
      const res = await fetch('/api/leaderboard');
      if (!res.ok) throw new Error("Network response was not ok");
      const entries = await res.json();
      const list = document.getElementById('leaderboard-list');
      const championBox = document.getElementById('champion-box');
      
      if (Array.isArray(entries) && entries.length > 0) {
        const champion = entries[0];
        const championName = document.getElementById('champion-name');
        const championScore = document.getElementById('champion-score');
        championName.innerText = champion[0] || '---';
        championScore.innerText = 'Score: ' + (champion[1] || 0);
        championBox.style.display = 'block';
        
        list.innerHTML = "<strong>TOP PLAYERS:</strong><br>" + 
          entries.slice(0,5).map((e, i) => '<li>' + (i+1) + '. ' + (e[0] || "---") + ': ' + (e[1] || 0) + '</li>').join('');
      } else {
        championBox.style.display = 'none';
        list.innerText = "No scores yet!";
      }
    } catch (e) { 
      console.error("Leaderboard error:", e);
      document.getElementById('leaderboard-list').innerText = "Leaderboard Offline"; 
    }
  }

  async function checkIfTopScore() {
    try {
      const res = await fetch('/api/leaderboard');
      if (!res.ok) return false;
      const entries = await res.json();
      if (!Array.isArray(entries) || entries.length === 0) return true;
      if (entries.length < 5) return true;
      return score > (entries[4][1] || 0);
    } catch (e) {
      return false;
    }
  }

  async function saveNameToBoard() {
    const name = document.getElementById('player-name').value.trim();
    if (!name) return alert("Enter a name!");
    
    try {
      const res = await fetch('/api/leaderboard', {
        method: "POST",
        headers: { "Content-Type": "application/json" }, 
        body: JSON.stringify({ name: name, score: score })
      });
      
      if (res.ok) {
        document.getElementById('save-message').innerText = 'SCORE SAVED! üéâ';
        document.getElementById('player-name').style.display = 'none';
        document.getElementById('save-name-btn').style.display = 'none';
        setTimeout(fetchLeaderboard, 500);
      }
    } catch (err) { console.error("Submit Error:", err); }
  }

  async function autoSaveScore() {
    if (isLoggedIn) {
      try {
        const res = await fetch('/api/score', {
          method: "POST",
          headers: { "Content-Type": "application/json" }, 
          body: JSON.stringify({ score: score, coins: coinsEarned })
        });
        
        if (res.ok) {
          const data = await res.json();
          document.getElementById('save-message').innerText = 'üí∞ ' + coinsEarned + ' coins earned!';
          document.getElementById('save-section').style.display = 'block';
          currentUser.currency = data.new_balance;
          currentUser.best_score = data.best_score;
          updateAuthUI();
          setTimeout(fetchLeaderboard, 500);
        }
      } catch (err) { console.error("Submit Error:", err); }
    } else {
      const isTopScore = await checkIfTopScore();
      if (isTopScore) {
        document.getElementById('save-message').innerText = 'NEW TOP SCORE! üåü ENTER YOUR NAME:';
        document.getElementById('player-name').style.display = 'block';
        document.getElementById('save-name-btn').style.display = 'block';
        document.getElementById('save-section').style.display = 'block';
      } else {
        document.getElementById('save-message').innerText = 'GAME OVER';
        document.getElementById('save-section').style.display = 'block';
        setTimeout(fetchLeaderboard, 2000);
      }
    }
  }

  function togglePause() { if (!running || isDead) return; isPaused = !isPaused; pauseOverlay.style.display = isPaused ? 'flex' : 'none'; }

  function showReady() {
    menu.style.display = 'none'; readyOverlay.style.display = 'flex';
    document.getElementById('save-section').style.display = 'none';
    scoreEl.style.display = 'block'; scoreEl.innerText = "0"; score = 0; coinsEarned = 0;
    document.getElementById('coins-display').innerText = 'üí∞ 0';
    isDead = false; isPaused = false; waiting = true; running = false;
    by = 230; rotation = 0; bv = 0;
    pipes.forEach(p => { p.t.remove(); p.b.remove(); }); pipes = [];
    buildings.forEach(b => b.el.remove()); buildings = [];
    clouds.forEach(c => c.el.remove()); clouds = [];
    updateTimeOfDay();
    fetchLeaderboard();
  }

  function startPhysics() { waiting = false; running = true; readyOverlay.style.display = 'none'; pauseBtn.style.display = 'block'; document.getElementById('coins-display').style.display = 'block'; doJump(); }
  function doJump() { bv = jump; rotation = -25; wing.classList.add('flap'); setTimeout(() => wing.classList.remove('flap'), 120); }

  function createBuilding() {
    const building = document.createElement('div');
    const w = 45 + Math.random() * 25, h = 60 + Math.random() * 120;
    building.className = 'building'; building.style.width = w + 'px'; building.style.height = h + 'px'; building.style.left = '330px';
    const cols = Math.floor(w / 12), rows = Math.floor(h / 15);
    building.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    for (let i = 0; i < cols * rows; i++) {
        const win = document.createElement('div');
        win.className = 'window' + (Math.random() > 0.85 ? ' lit' : '');
        building.appendChild(win);
    }
    game.appendChild(building);
    buildings.push({ el: building, x: 330, s: 0.6 });
  }

  function createCloud() {
    const cloud = document.createElement('div');
    const size = 30 + Math.random() * 50;
    cloud.className = 'cloud'; cloud.style.width = size + 'px'; cloud.style.height = (size * 0.5) + 'px';
    cloud.style.left = '330px'; cloud.style.top = (Math.random() * 120) + 'px';
    game.appendChild(cloud);
    clouds.push({ el: cloud, x: 330, s: 0.3 + Math.random() * 0.3 });
  }

  function createPipe() {
    let gap = 125, h = Math.random() * 180 + 60;
    let t = document.createElement('div'), b = document.createElement('div');
    t.className = 'pipe'; b.className = 'pipe';
    t.style.height = h + 'px'; t.style.top = '0';
    b.style.height = (440 - h - gap) + 'px'; b.style.bottom = '40px';
    t.innerHTML = '<div class="pipe-cap" style="bottom:-2px"></div>';
    b.innerHTML = '<div class="pipe-cap" style="top:-2px"></div>';
    [t, b].forEach(el => { el.style.left = '320px'; game.appendChild(el); });
    pipes.push({ t, b, x: 320, passed: false });
  }

  function updateTimeOfDay() {
    if (score < 5) game.style.background = "#70c5ce"; 
    else if (score < 12) game.style.background = "#4da9ff"; 
    else if (score < 20) game.style.background = "#e86101"; 
    else game.style.background = "#1a1a2e"; 
  }

  function gameOver() {
    isDead = true; running = false;
    flash.classList.add('flash-active'); setTimeout(() => flash.classList.remove('flash-active'), 200);
    
    if (isLoggedIn) {
      if (score > currentUser.best_score) highscore = score;
    } else {
      if (score > highscore) highscore = score;
    }
    
    finalScoreEl.innerText = score; 
    if (isLoggedIn && currentUser) {
      highScoreEl.innerText = currentUser.best_score;
    } else {
      highScoreEl.innerText = highscore;
    }
    
    setTimeout(() => { 
      menu.style.display = 'flex'; 
      scoreEl.style.display = 'none'; 
      pauseBtn.style.display = 'none'; 
      autoSaveScore();
    }, 500);
  }

  function update() {
    if (isPaused) return requestAnimationFrame(update);
    tick++;
    groundX = (groundX - gameSpeed) % 320;
    groundEl.style.transform = `translateX(${groundX}px)`;

    if (Math.random() < 0.01) createCloud();
    for (let i = clouds.length - 1; i >= 0; i--) {
      clouds[i].x -= clouds[i].s;
      clouds[i].el.style.left = clouds[i].x + 'px';
      if (clouds[i].x < -100) { clouds[i].el.remove(); clouds.splice(i, 1); }
    }

    if (Math.random() < 0.015) createBuilding();
    for (let i = buildings.length - 1; i >= 0; i--) {
      buildings[i].x -= buildings[i].s;
      buildings[i].el.style.left = buildings[i].x + 'px';
      if (buildings[i].x < -100) { buildings[i].el.remove(); buildings.splice(i, 1); }
    }

    if (!running && !isDead) {
        bird.style.top = (by + Math.sin(tick * 0.1) * 8) + 'px'; bird.style.transform = 'rotate(0deg)';
    } else if (running && !isDead) {
        bv += gravity; by += bv;
        rotation = bv > 0 ? Math.min(rotation + 4, 90) : Math.max(rotation - 2, -25);
        bird.style.top = by + 'px'; bird.style.transform = `rotate(${rotation}deg)`;
        if (by < 0 || by > 420) gameOver();
        if (pipes.length === 0) createPipe();
        for (let i = pipes.length - 1; i >= 0; i--) {
            let p = pipes[i];
            p.x -= gameSpeed; p.t.style.left = p.b.style.left = p.x + 'px';
            const br = bird.getBoundingClientRect(), tr = p.t.getBoundingClientRect(), bbr = p.b.getBoundingClientRect();
            if (br.right > tr.left && br.left < tr.right && (br.top < tr.bottom || br.bottom > bbr.top)) gameOver();
            if (!p.passed && p.x < 50) { 
              p.passed = true; 
              score++; 
              coinsEarned++;
              scoreEl.innerText = score; 
              document.getElementById('coins-display').innerText = 'üí∞ ' + coinsEarned;
              updateTimeOfDay(); 
            }
            if (p.x < -60) { p.t.remove(); p.b.remove(); pipes.splice(i, 1); }
        }
    }
    requestAnimationFrame(update);
  }

  window.addEventListener('keydown', e => { 
      if (e.code === 'Space' || e.key === 'ArrowUp') { if (waiting) startPhysics(); else if (running && !isDead && !isPaused) doJump(); }
      if (e.key.toLowerCase() === 'p') togglePause();
  });
  game.addEventListener('mousedown', () => { if (waiting) startPhysics(); else if (running && !isDead && !isPaused) doJump(); });
  
  checkAuth().then(() => {
    update();
    fetchLeaderboard();
    highScoreEl.innerText = highscore;
    document.getElementById('coins-display').style.display = 'none';
  });
</script>
</body>
</html>
